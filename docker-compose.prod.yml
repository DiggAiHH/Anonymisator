services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8000:8000"
    environment:
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-8000}
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-false}

      SECUREDOC_REQUIRE_API_KEY: ${SECUREDOC_REQUIRE_API_KEY:-true}
      SECUREDOC_API_KEY: ${SECUREDOC_API_KEY:-}
      SECUREDOC_RATE_LIMIT_ENABLED: ${SECUREDOC_RATE_LIMIT_ENABLED:-true}
      SECUREDOC_RATE_LIMIT_RPS: ${SECUREDOC_RATE_LIMIT_RPS:-2}
      SECUREDOC_RATE_LIMIT_BURST: ${SECUREDOC_RATE_LIMIT_BURST:-5}

      REIDENTIFY_FAIL_ON_MISSING_PLACEHOLDERS: ${REIDENTIFY_FAIL_ON_MISSING_PLACEHOLDERS:-false}

      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      LLM_API_URL: ${LLM_API_URL:-https://api.openai.com/v1/chat/completions}
      LLM_API_KEY: ${LLM_API_KEY:-}
      LLM_MODEL: ${LLM_MODEL:-gpt-4}
      LLM_TIMEOUT: ${LLM_TIMEOUT:-60}
      LLM_MAX_RETRIES: ${LLM_MAX_RETRIES:-3}
      LLM_RETRY_DELAY: ${LLM_RETRY_DELAY:-1.0}
      LLM_MASTER_PROMPT_PATH: ${LLM_MASTER_PROMPT_PATH:-.1Promp/Master Prompt}

      STRIPE_API_KEY: ${STRIPE_API_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    ports:
      - "3000:3000"
    environment:
      MCP_PORT: ${MCP_PORT:-3000}
      MCP_REQUIRE_API_KEY: ${MCP_REQUIRE_API_KEY:-true}
      MCP_API_KEY: ${MCP_API_KEY:-}
      MCP_RATE_LIMIT_ENABLED: ${MCP_RATE_LIMIT_ENABLED:-true}
      MCP_RATE_LIMIT_RPS: ${MCP_RATE_LIMIT_RPS:-2}
      MCP_RATE_LIMIT_BURST: ${MCP_RATE_LIMIT_BURST:-5}
      NODE_ENV: ${NODE_ENV:-production}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/health', r => process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1));"
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
